import os
import time
import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin


# === CONFIGURAÃ‡Ã•ES ===
OUTPUT_DIR = "downloads"
os.makedirs(OUTPUT_DIR, exist_ok=True)

HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0 Safari/537.36"
}

# PÃ¡ginas iniciais para busca
SITES_INICIAIS = [
    "https://www.ibge.gov.br ",
    "https://www.inep.gov.br ",
    "https://www.atlasbrasil.org.br ",  # Site oficial do Atlas
]

# Palavras-chave para buscar links relevantes
PALAVRAS_CHAVE = [
    "atlas", "2013", "dados", "bruto", "csv", "xlsx", "download", "educacao"
]


def extrair_links(url):
    """Extrai todos os links de uma pÃ¡gina"""
    try:
        print(f"ğŸ”— Acessando: {url}")
        response = requests.get(url, headers=HEADERS, timeout=15)
        if response.status_code != 200:
            print(f"âŒ NÃ£o foi possÃ­vel acessar {url} (status {response.status_code})")
            return []

        soup = BeautifulSoup(response.text, "html.parser")
        links = set()

        for a in soup.find_all("a", href=True):
            link_completo = urljoin(url, a["href"])
            links.add(link_completo)

        print(f"ğŸ”— Encontrados {len(links)} links em {url}")
        return list(links)

    except Exception as e:
        print(f"âš ï¸ Erro ao processar {url}: {e}")
        return []


def eh_link_relevante(url):
    """Verifica se o link parece relevante para o Atlas 2013"""
    url_lower = url.lower()
    return any(palavra in url_lower for palavra in PALAVRAS_CHAVE)


def eh_arquivo_csv_xlsx_zip(url):
    """Verifica se Ã© um arquivo CSV, XLSX ou ZIP"""
    return any(url.lower().endswith(ext) for ext in [".csv", ".xlsx", ".xls", ".zip"])


def baixar_arquivo(url):
    """Baixa o arquivo e salva localmente"""
    try:
        print(f"ğŸ“¥ Tentando baixar: {url}")
        response = requests.get(url, headers=HEADERS, stream=True, timeout=30)
        if response.status_code == 200:
            filename = os.path.join(OUTPUT_DIR, os.path.basename(url))
            with open(filename, "wb") as f:
                for chunk in response.iter_content(chunk_size=1024):
                    if chunk:
                        f.write(chunk)
            print(f"âœ… Arquivo salvo em: {filename}")
            return True
        else:
            print(f"âŒ Erro ao baixar ({response.status_code}): {url}")
            return False
    except Exception as e:
        print(f"âš ï¸ Falha ao baixar {url}: {e}")
        return False


def varrer_pagina(url):
    """Varre uma pÃ¡gina por links relevantes e tenta baixar arquivos"""
    links = extrair_links(url)
    resultados = []

    for link in links:
        if eh_arquivo_csv_xlsx_zip(link) and eh_link_relevante(link):
            print(f"ğŸ“ Arquivo encontrado: {link}")
            sucesso = baixar_arquivo(link)
            if sucesso:
                resultados.append(link)
                return resultados  # Para apÃ³s encontrar o primeiro vÃ¡lido

    # Se nÃ£o encontrou arquivos diretos, procura pÃ¡ginas com conteÃºdo Ãºtil
    for link in links:
        if eh_link_relevante(link):
            print(f"ğŸ” Indo mais fundo: {link}")
            sub_resultados = varrer_pagina(link)
            if sub_resultados:
                return sub_resultados

    return resultados


def main():
    print("ğŸŒ Iniciando busca no IBGE, INEP e Atlas Brasil")

    for site in SITES_INICIAIS:
        print(f"\nğŸ” Buscando no site: {site}")
        resultado = varrer_pagina(site)
        if resultado:
            print("ğŸ‰ Arquivo encontrado e baixado com sucesso!")
            break
        else:
            print(f"âŒ Nenhum arquivo encontrado em {site}")

    print("\nğŸ Busca concluÃ­da.")


if __name__ == "__main__":
    main()
